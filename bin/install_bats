#!/bin/bash
#
set -e
test -d "$(PWD)"

url="https://github.com/bats-core/bats-core/archive/v1.8.0.tar.gz"
sha256="0d4c44823905af5e52a92f9164595c183fb0d0b43b0c4e9c9acf794af20468b7"
tmpdir=$(PWD)/.eviltest

rm -rf "$tmpdir"
mkdir -p "$tmpdir"

function cleanup {
    rm -rf "$tmpdir"
}
trap cleanup EXIT

cd "$tmpdir"
tardir=$(unpack_from_url "$url" "$sha256")
"$tardir/install.sh" "$HOME/.bats"

function echo_path_code {
    echo "# Added by eviltest"
    echo "PATH=$HOME/.bats/bin:\$PATH"
    echo "BATS_LIB_PATH=$HOME/.bats/lib"
    echo "export BATS_LIB_PATH"
    echo "export PATH"
    echo "# End by eviltest"

}

function echo_path_code_fish {
    echo "# Added by eviltest"
    echo "fish_add_path -g \"$HOME/.bats/bin\""
    echo "set -gx BATS_LIB_PATH \"$HOME/.bats/lib\""
    echo "# End by eviltest"
}

function rm_old_path_code {

    local shprof=$1
    local size=$2
    local tmpfile
    local B
    local E

    B=$(grep -n "# Added by eviltest" "$shprof" | cut -f1 -d':' | head -n1)
    E=$(grep -n "# End by eviltest" "$shprof" | cut -f1 -d':' | head -n1)

    if ((E - B == size - 1)); then
        cp "$shprof" "$shprof".bak
        tmpfile=$(mktemp)
        {
            head -n$((B - 1)) "$shprof"
            tail -n +$((E + 1)) "$shprof"
        } >"$tmpfile"
        mv "$tmpfile" "$shprof"
    fi
}

function edit_shell_profile {
    local shprof
    local shell
    local size

    shell=$(get_shell)

    if [ "$shell" = "fish" ]; then
        shprof=$HOME/.config/fish/config.fish

        size=$(echo_path_code_fish | wc -l | xargs)
        rm_old_path_code "$shprof" "$size"
        echo_path_code_fish >>"$shprof"

    elif [ "$shell" = "zsh" ]; then
        shprof=$HOME/.zprofile

        size=$(echo_path_code | wc -l | xargs)
        rm_old_path_code "$shprof" "$size"

        echo_path_code >>"$shprof"
    else
        for name in .profile .bash_profile .bashrc; do
            shprof=$HOME/$name
            if test -f "$shprof"; then
                size=$(echo_path_code_fish | wc -l | xargs)
                rm_old_path_code "$shprof" "$size"
                echo_path_code >>"$shprof"
                break
            fi
        done
    fi
}

edit_shell_profile
